{"version":3,"sources":["components/formRepeat.js"],"names":["dmx","Component","initialData","canAdd","items","attributes","type","Array","Number","default","min","max","Infinity","sortable","Boolean","handle","String","animation","methods","add","this","_add","requestAnimationFrame","dispatchEvent","remove","index","_remove","move","oldIndex","newIndex","_move","moveToStart","moveToEnd","children","length","moveBefore","moveAfter","duplicate","_duplicate","reset","_render","events","added","Event","moved","removed","duplicated","update","updated","render","node","_template","_templateFromChildren","querySelectorAll","forEach","input","firstBracket","name","indexOf","setAttribute","slice","props","_sortable","Sortable","create","onEnd","event","_refresh","performUpdate","updatedProps","has","option","repeatItems","_clear","i","nextTick","fromInputs","$nodes","nodeType","push","from","toInputs","fromInput","toInput","tagName","value","checked","multiple","fromOption","selectedOptions","toOption","options","selected","data","child","cloneNode","$node","appendChild","$parse","splice","$destroy","set","$index","$formindex","$canRemove","$canMoveToStart","$canMoveBefore","$canMoveAfter","$canMoveToEnd","map","innerHTML","updateDOM","template","document","createDocumentFragment","hasChildNodes","firstChild"],"mappings":"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","file":"dmxFormRepeat.js","sourcesContent":["dmx.Component('form-repeat', {\r\n\r\n  initialData: {\r\n    canAdd: true,\r\n    items: []\r\n  },\r\n\r\n  attributes: {\r\n\r\n    items: {\r\n      type: [Array, Number],\r\n      default: 0\r\n    },\r\n\r\n    min: {\r\n      type: Number,\r\n      default: 0\r\n    },\r\n\r\n    max: {\r\n      type: Number,\r\n      default: Infinity\r\n    },\r\n\r\n    sortable: {\r\n      type: Boolean,\r\n      default: false\r\n    },\r\n\r\n    handle: {\r\n      type: String,\r\n      default: null\r\n    },\r\n\r\n    animation: {\r\n      type: Number,\r\n      default: 0\r\n    }\r\n\r\n  },\r\n\r\n  methods: {\r\n\r\n    add () {\r\n      this._add();\r\n      requestAnimationFrame(() => {\r\n        this.dispatchEvent('added');\r\n      });\r\n    },\r\n\r\n    remove (index) {\r\n      this._remove(index);\r\n      requestAnimationFrame(() => {\r\n        this.dispatchEvent('removed', null, { index });\r\n      });\r\n    },\r\n\r\n    move (oldIndex, newIndex) {\r\n      this._move(oldIndex, newIndex, true);\r\n    },\r\n\r\n    moveToStart (index) {\r\n      this._move(index, 0, true);\r\n    },\r\n\r\n    moveToEnd (index) {\r\n      this._move(index, this.children.length - 1, true);\r\n    },\r\n\r\n    moveBefore (index) {\r\n      this._move(index, index - 1, true);\r\n    },\r\n\r\n    moveAfter (index) {\r\n      this._move(index, index + 1, true);\r\n    },\r\n\r\n    duplicate (index) {\r\n      this._duplicate(index);\r\n      requestAnimationFrame(() => {\r\n        this.dispatchEvent('duplicated', null, { index });\r\n      });\r\n    },\r\n\r\n    reset () {\r\n      this._render();\r\n    }\r\n\r\n  },\r\n\r\n  events: {\r\n    added: Event,\r\n    moved: Event,\r\n    removed: Event,\r\n    duplicated: Event,\r\n    update: Event,\r\n    updated: Event\r\n  },\r\n\r\n  render (node) {\r\n    this._template = this._templateFromChildren(node);\r\n\r\n    const inputs = this._template.querySelectorAll('input[name], select[name], textarea[name]');\r\n\r\n    inputs.forEach((input) => {\r\n      const firstBracket = input.name.indexOf('[');\r\n\r\n      if (firstBracket > 0) {\r\n        input.setAttribute('dmx-bind:name', this.name + '[{{$formindex}}][' + input.name.slice(0, firstBracket) + ']' + input.name.slice(firstBracket));\r\n      } else {\r\n        input.setAttribute('dmx-bind:name', this.name + '[{{$formindex}}][' + input.name + ']');\r\n      }\r\n    });\r\n\r\n    if (this.props.sortable) {\r\n      this._sortable = Sortable.create(node, {\r\n        handle: this.props.handle,\r\n        onEnd: event => this._move(event.oldIndex, event.newIndex),\r\n      });\r\n    }\r\n\r\n    this._render();\r\n    this._refresh();\r\n  },\r\n\r\n  performUpdate (updatedProps) {\r\n    if (updatedProps.has('items')) {\r\n      this._render();\r\n    }\r\n\r\n    if (updatedProps.has('sortable')) {\r\n      if (this._sortable) {\r\n        this._sortable.option('disabled', !this.props.sortable);\r\n      } else {\r\n        this._sortable = Sortable.create(node, {\r\n          handle: this.props.handle,\r\n          onEnd: event => this._move(event.oldIndex, event.newIndex),\r\n        });\r\n      }\r\n    }\r\n\r\n    if (updatedProps.has('handle')) {\r\n      if (this._sortable) {\r\n        this._sortable.option('handle', this.props.handle);\r\n      }\r\n    }\r\n\r\n    if (updatedProps.has('animation')) {\r\n      if (this._sortable) {\r\n        this._sortable.option('animation', this.props.animation);\r\n      }\r\n    }\r\n\r\n    this._refresh();\r\n  },\r\n\r\n  _render () {\r\n    const items = dmx.repeatItems(typeof this.props.items == 'string' ? Number(this.props.items) : this.props.items);\r\n\r\n    if (items.length < this.props.min) items.length = this.props.min;\r\n    if (items.length > this.props.max) items.length = this.props.max;\r\n\r\n    this.dispatchEvent(\"update\");\r\n\r\n    this._clear();\r\n\r\n    for (let i = 0; i < items.length; i++) {\r\n      this._add(items[i]);\r\n    }\r\n\r\n    dmx.nextTick(() => this.dispatchEvent(\"updated\"));\r\n  },\r\n\r\n  _duplicate (index) {\r\n    this._add();\r\n\r\n    this._move(this.children.length - 1, index + 1, true);\r\n\r\n    let fromInputs = [];\r\n    this.children[index].$nodes.forEach((node) => {\r\n      if (node.nodeType == 1) {\r\n        fromInputs.push(...Array.from(node.querySelectorAll('input[name], textarea[name], select[name]')));\r\n      }\r\n    });\r\n\r\n    let toInputs = [];\r\n    this.children[index + 1].$nodes.forEach((node) => {\r\n      if (node.nodeType == 1) {\r\n        toInputs.push(...Array.from(node.querySelectorAll('input[name], textarea[name], select[name]')));\r\n      }\r\n    });\r\n\r\n    // Only do something when the inputs match\r\n    if (fromInputs.length == toInputs.length) {\r\n      for (let i = 0; i < fromInputs.length; i++) {\r\n        const fromInput = fromInputs[i];\r\n        const toInput = toInputs[i];\r\n\r\n        // Inputs do not match???\r\n        if (fromInput.tagName != toInput.tagName) break;\r\n\r\n        if (fromInput.tagName == 'TEXTAREA') {\r\n          // textarea just copy value\r\n          toInput.value = fromInput.value;\r\n        } else if (fromInput.tagName == 'INPUT') {\r\n          if (fromInput.type == 'file' || fromInput.type == 'password') {\r\n            // skip file and password types\r\n            continue;\r\n          }\r\n\r\n          if (fromInput.type == 'checkbox' || fromInput.type == 'radio') {\r\n            // checkbox and radio we have to copy the checked property\r\n            toInput.checked = fromInput.checked;\r\n          } else {\r\n            // any other type input just copy value\r\n            toInput.value = fromInput.value;\r\n          }\r\n        } else if (fromInput.tagName == 'SELECT') {\r\n          if (fromInput.multiple) {\r\n            // for multiple selection we need to loop over the options\r\n            // first loop only the selected options\r\n            for (const fromOption of fromInput.selectedOptions) {\r\n              // second loop on target to find matching value\r\n              for (const toOption of toInput.options) {\r\n                if (fromOption.value == toOption.value) {\r\n                  // set selected when value matches\r\n                  toOption.selected = true;\r\n                }\r\n              }\r\n            }\r\n          } else {\r\n            // for single selection we can simply copy the value\r\n            toInput.value = fromInput.value;\r\n          }\r\n        }\r\n\r\n        // trigger a change event on the target to let App Connect know it changed\r\n        toInput.dispatchEvent(new Event('change'));\r\n      }\r\n    }\r\n  },\r\n\r\n  _add (data = {}) {\r\n    if (this.children.length >= this.props.max) return;\r\n\r\n    const RepeatItem = dmx.Component('repeat-item');\r\n    const child = new RepeatItem(this._template.cloneNode(true), this, data);\r\n\r\n    child.$nodes.forEach((node) => {\r\n      this.$node.appendChild(node);\r\n      child.$parse(node);\r\n    });\r\n\r\n    this.children.push(child);\r\n\r\n    this._refresh();\r\n  },\r\n\r\n  _remove (index) {\r\n    if (this.children.length <= this.props.min) return;\r\n\r\n    this.children.splice(index, 1).forEach((child) => {\r\n      child.$destroy();\r\n    });\r\n\r\n    this._refresh();\r\n  },\r\n\r\n  _refresh () {\r\n    this.children.forEach((child, index) => {\r\n      child.set({\r\n        $index: index,\r\n        $formindex: index,\r\n        $canRemove: this.children.length > this.props.min,\r\n        $canMoveToStart: index > 0,\r\n        $canMoveBefore: index > 0,\r\n        $canMoveAfter: index < this.children.length - 1,\r\n        $canMoveToEnd: index < this.children.length - 1\r\n      });\r\n    });\r\n\r\n    this.set('canAdd', this.children.length < this.props.max);\r\n    this.set('items', this.children.map(child => child.data));\r\n  },\r\n\r\n  _clear () {\r\n    this.children.splice(0).forEach((child) => {\r\n      child.$destroy();\r\n    });\r\n\r\n    this.$node.innerHTML = '';\r\n  },\r\n\r\n  _move (oldIndex, newIndex, updateDOM) {\r\n    if (oldIndex < 0 || oldIndex >= this.children.length) return;\r\n    if (newIndex < 0 || newIndex >= this.children.length) return;\r\n\r\n    this.children.splice(newIndex, 0, this.children.splice(oldIndex, 1)[0]);\r\n\r\n    if (updateDOM) {\r\n      this.$node.innerHTML = '';\r\n      this.children.forEach(child => {\r\n        child.$nodes.forEach((node) => {\r\n          this.$node.appendChild(node);\r\n        });\r\n      })\r\n    }\r\n\r\n    this._refresh();\r\n\r\n    requestAnimationFrame(() => {\r\n      this.dispatchEvent('moved', null, { oldIndex, newIndex });\r\n    });\r\n  },\r\n\r\n  _templateFromChildren (node) {\r\n    const template = document.createDocumentFragment();\r\n\r\n    while (node.hasChildNodes()) {\r\n      template.appendChild(node.firstChild);\r\n    }\r\n\r\n    return template;\r\n  }\r\n\r\n});"]}