/*!
 App Connect Google Places
 Version: 2.0.0
 (c) 2024 Wappler.io
 @build 2024-04-15 17:48:46
 */
dmx.Component("google-autocomplete",{extends:"form-element",initialData:{placeId:null,address:null,phone:null,phone2:null,latitude:null,longitude:null,icon:null,name:null,priceLevel:null,rating:null,types:null,url:null,utcOffset:null,vicinity:null,website:null},attributes:{map:{type:String,default:null},country:{type:String,default:null},types:{type:String,default:null},strictBounds:{type:Boolean,default:!1},moveMap:{type:Boolean,default:!1}},render(e){this._autocomplete=new google.maps.places.Autocomplete(e,{strictBounds:this.props.strictBounds,types:this.props.types?this.props.types.split(/\s*,\s*/):[]}),this.props.map&&requestAnimationFrame((()=>{this._map=this._getMap(),this._autocomplete.bindTo("bounds",this._map)})),this.props.country&&this._autocomplete.setComponentRestrictions({country:this.props.country.split(/\s*,\s*/)}),this._placeChangedHandler=this._placeChangedHandler.bind(this),this._autocomplete.addListener("place_changed",this._placeChangedHandler),this.set("value",this.props.value),this.set("disabled",this.props.disabled)},performUpdate(e){e.has("map")&&(this._map=this._getMap(),this._autocomplete.bindTo("bounds",this._map)),e.has("strictBounds")&&this._autocomplete.setOptions({strictBounds:this.props.strictBounds}),e.has("types")&&this._autocomplete.setTypes(this.props.types),e.has("country")&&this._autocomplete.setComponentRestrictions({country:this.props.country?this.props.country.split(/\s*,\s*/):[]}),e.has("value")&&this._setValue(this.props.value,!0),e.has("disabled")&&this._disable(this.props.disabled)},destroy(){},_getMap(){if(this.props.map){const e=document.getElementById(this.props.map);return e&&e.dmxComponent&&e.dmxComponent._map}},_placeChangedHandler(){const e=this._autocomplete.getPlace();e.place_id&&(this.set("value",this.$node.value),this.set({placeId:e.place_id,address:e.formatted_address,phone:e.formatted_phone_number,phone2:e.international_phone_number,latitude:e.geometry&&e.geometry.location.lat(),longitude:e.geometry&&e.geometry.location.lng(),attributions:e.html_attributions,icon:e.icon,name:e.name,isOpen:e.opening_hours&&e.opening_hours.isOpen(),priceLevel:e.price_level,rating:e.rating,types:e.types,url:e.url,userRatingsTotal:e.user_ratings_total,utcOffset:e.utc_offset_minutes,vicinity:e.vicinity,website:e.website,adrAddress:e.adr_address,components:Array.isArray(e.address_components)?e.address_components.reduce((function(e,t){return t.types.forEach((function(s){e[s.replace(/_(\w)/g,(function(e,t){return t.toUpperCase()}))]={long:t.long_name,short:t.short_name}})),e}),{}):null}),this.props.moveMap&&this._map&&(e.geometry.viewport?this._map.fitBounds(e.geometry.viewport):(this._map.setCenter(e.geometry.location),this._map.setZoom(17))),setTimeout(this.dispatchEvent.bind(this,"updated"),100))}}),dmx.Component("google-places-search",{initialData:{results:[],hasMore:!1,status:""},attributes:{map:{type:String,default:null},fields:{type:[Array,String],default:["place_id","business_status","formatted_address","geometry","icon","name","type"]},showOnMap:{type:Boolean,default:!1}},methods:{findPlaceFromQuery(e){this._findPlaceFrom("query",e)},findPlaceFromPhoneNumber(e){this._findPlaceFrom("phoneNumber",e)},nearby(e){this._search(e,!0)},search(e){this._search(e)},getMore(){this._getMore()}},init(){this._markers=[],this.props.map&&requestAnimationFrame((()=>{const e=document.getElementById(this.props.map);this._cluster=e&&e.dmxComponent&&e.dmxComponent._cluster,this._map=e&&e.dmxComponent&&e.dmxComponent._map}))},performUpdate(e){if(e.has("map"))if(this.props.map){const e=document.getElementById(this.props.map);this._cluster=e&&e.dmxComponent&&e.dmxComponent._cluster,this._map=e&&e.dmxComponent&&e.dmxComponent._map}else this._cluster=null,this._map=null},destroy(){},_clearMarkers(){this._cluster&&this._cluster.clearMarkers(),this._markers=this._markers.filter((e=>(google.maps.event.clearInstanceListeners(e),e.setMap(null),!1)))},_findPlaceFrom(e,t){this._clearMarkers();const s=t.fields||this.props.fields,o={[e]:t[e],fields:Array.isArray(s)?s:s.split(/\s*,\s*/)};t.bindBounds&&this._map?o.locationBias=this._map.getBounds():t.latitude&&t.longitude&&(t.radius?o.locationBias={center:{lat:+t.latitude,lng:+t.longitude},radius:+t.radius}:o.locationBias={lat:+t.latitude,lng:+t.longitude});new google.maps.places.PlacesService(this._map)["findPlaceFrom"+this._ucase(e)](o,this._results.bind(this))},_search(e,t=!1){this._clearMarkers();const s=t?"type":"query",o={[s]:e[s]};null!=e.latitude&&null!=e.longitude?(o.location={lat:+e.latitude,lng:+e.longitude},o.radius=+e.radius||500):this._map&&(o.bounds=this._map.getBounds()),e.keyword&&(o.keyword=e.keyword),e.name&&(o.name=e.name),e.openNow&&(o.openNow=e.openNow);new google.maps.places.PlacesService(this._map)[(t?"nearby":"text")+"Search"](o,this._results.bind(this))},_getMore(){this._pagination&&this._pagination.hasNextPage&&this._pagination.nextPage()},_results(e,t,s){this.set("status",t),this.set("hasMore",!(!s||!s.hasNextPage)),this._pagination=s,"OK"==t?(this.set("results",e.map((e=>({placeId:e.place_id,address:e.formatted_address,latitude:e.geometry.location.lat(),longitude:e.geometry.location.lng(),icon:e.icon,name:e.name,types:e.types})))),this.props.showOnMap&&e.forEach((e=>{const t={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)},s=new google.maps.Marker({icon:t,title:e.name,position:e.geometry.location});this._cluster?this._cluster.addMarker(s):s.setMap(this._map),this._markers.push(s)}))):console.warn(`Places search failed: ${t}`)},_ucase:e=>e[0].toUpperCase()+e.slice(1)});
//# sourceMappingURL=dmxGooglePlaces.js.map
